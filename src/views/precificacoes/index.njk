{% extends "layout.njk" %}

{% block content %}
<div class="container py-4">

  <!-- Cabeçalho -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body p-4 d-flex justify-content-between align-items-center">

      <div>
        <h2 class="fw-bold text-primary mb-1">
          <i class="bi bi-cash-coin"></i> Precificações
        </h2>
        <p class="text-muted mb-0">Gerencie todas as precificações realizadas no sistema.</p>
      </div>

      <a href="/precificacoes/new" class="btn btn-success btn-lg">
        <i class="bi bi-plus-circle"></i> Nova Precificação
      </a>

    </div>
  </div>

  <!-- Busca -->
  <form method="GET" action="/precificacoes" class="card shadow-sm border-0 mb-4">
    <div class="card-body p-4 row g-3">

      <div class="col-md-8">
        <input 
          type="text" 
          name="search" 
          value="{{ search }}"
          class="form-control" 
          placeholder="Buscar por nome do produto ou tamanho…">
      </div>

      <div class="col-md-4 d-flex">
        <button class="btn btn-primary w-100 me-2" type="submit">
          <i class="bi bi-search"></i> Buscar
        </button>

        {% if search %}
        <a href="/precificacoes" class="btn btn-secondary w-100">
          Limpar
        </a>
        {% endif %}
      </div>

    </div>
  </form>

  <!-- Lista de Precificações -->
  <div class="card shadow-sm border-0">
    <div class="card-body p-4">

      {% if precificacoes.length == 0 %}
        <div class="text-center py-5">
          <h4 class="text-muted">
            <i class="bi bi-info-circle"></i><br>
            Nenhuma precificação encontrada.
          </h4>
        </div>
      {% else %}

      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Produto</th>
              <th>Custo Total</th>
              <th>Preço Sugerido</th>
              <th>Margem (%)</th>
              <th>Data</th>
              <th class="text-end">Ações</th>
            </tr>
          </thead>

          <tbody>
            {% for p in precificacoes %}
            <tr>
              <td>
                <strong>{{ p.productName }}</strong>
                {% if p.size %}
                <br><span class="text-muted">{{ p.size }}</span>
                {% endif %}
              </td>

              <td>R$ {{ p.totalCost.toFixed(2).replace('.', ',') }}</td>

              <td>
                <span class="fw-bold text-primary">
                  R$ {{ p.suggestedPrice.toFixed(2).replace('.', ',') }}
                </span>
              </td>

              <td>{{ p.margin }}%</td>

              <td>{{ p.createdAt.toLocaleDateString("pt-BR") }}</td>

              <td class="text-end">

                <!-- Ver -->
                <a href="/precificacoes/{{ p._id }}" 
                   class="btn btn-sm btn-outline-primary me-1">
                  <i class="bi bi-eye"></i>
                </a>

                <!-- Deletar -->
                <form action="/precificacoes/delete/{{ p._id }}?_method=DELETE"
                      method="post" class="d-inline"
                      onsubmit="return confirm('Deseja mesmo excluir esta precificação?')">
                  <button class="btn btn-sm btn-outline-danger">
                    <i class="bi bi-trash"></i>
                  </button>
                </form>

              </td>

            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% endif %}
    </div>
  </div>

</div>
{% endblock %}
